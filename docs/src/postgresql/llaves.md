---
outline: deep
---

# Comandos para crear llaves primarias y foráneas

## Llave primaria (PK)

### Agregar campo como PK

```sql
ALTER TABLE country
ADD PRIMARY KEY (code);
```

### Constraint CHECK

Consiste en verificaciones a un campo o varios.

Ejemplo: Agregar un check donde la surfacearea debe ser mayor a cero

```sql
ALTER TABLE COUNTRY
ADD CHECK(surfacearea >= 0);
```


## Llave Foránea (FK)

:::tip
Existen 2 maneras para hacer una llave foránea: se puede incluir en el script de creación de tablas o se puede actualizar la tabla para agregar la llave foránea.
:::

### Crear con la llave foránea

Supongamos que queremos crear dos tablas: **usuarios** y **pedidos**. Cada pedido está asociado a un usuario a través de una clave foránea que referencia el ID del usuario.

```sql
-- Crear tabla usuarios
CREATE TABLE usuarios (
    usuario_id SERIAL PRIMARY KEY,
    nombre VARCHAR(100),
    email VARCHAR(100)
);

-- Crear tabla pedidos
CREATE TABLE pedidos (
    pedido_id SERIAL PRIMARY KEY,
    descripcion VARCHAR(255),
    fecha_pedido DATE,
    usuario_id INT REFERENCES usuarios(usuario_id)
);

```

Explicación del script:

1. Tabla usuarios:
    - usuario_id SERIAL PRIMARY KEY: Define un campo usuario_id que es una clave primaria autoincremental.
    - nombre VARCHAR(100): Campo para el nombre del usuario.
    - email VARCHAR(100): Campo para el correo electrónico del usuario.

2. Tabla pedidos:
    - pedido_id SERIAL PRIMARY KEY: Define un campo pedido_id que es una clave primaria autoincremental.
    - descripcion VARCHAR(255): Campo para la descripción del pedido.
    - fecha_pedido DATE: Campo para la fecha en que se realizó el pedido.
    - usuario_id INT REFERENCES usuarios(usuario_id): Define usuario_id como una clave foránea que referencia el usuario_id en la tabla usuarios.

3. Notas adicionales:

    - SERIAL: Es un tipo de datos en PostgreSQL que se utiliza para crear una columna autoincremental.

    - REFERENCES usuarios(usuario_id): Especifica que el campo usuario_id en la tabla pedidos hace referencia al campo usuario_id en la tabla usuarios.


### Alterando la tabla

Modificando la tabla para agregar un Foreign Key a un campo.

Ejemplo: Agregar a la tabla **city** la clave foranea *countrycode* de la tabla **country**

```sql
ALTER TABLE city
	ADD CONSTRAINT fk_country_code -- nombre de la clave foranea
	FOREIGN KEY (countrycode) -- campo con el que se relaciona
	REFERENCES country (code); -- a que tabla y campo hace referencia
```




## SERIAL vs IDENTITY

* SERIAL: para crear un identificador correlativo. Crea  automaticamente la secuencia.

```sql
CREATE TABLE users (
	user_id SERIAL PRIMARY KEY,
	username VARCHAR);
```

* IDENTITY:

1. Verifica que no se ingresen id de forma manual.

```sql
CREATE TABLE users2 (
	user_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	username VARCHAR);
```

2. Evita que se manipule el campo user_id.

```sql
CREATE TABLE users3 (
	user_id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	username VARCHAR);
```

3. Permite más control para la creación.

```sql
CREATE TABLE users4 (
	user_id INTEGER GENERATED ALWAYS AS IDENTITY (START WITH 100 INCREMENT BY 2),
	username VARCHAR);
```

## Llave Primaria Compuesta

La combinación de estas llaves es **ÚNICA**. Jamás se va a repetir.

Supongamos que queremos crear una tabla **usuarios** con una llave primaria compuesta usando las columnas *id_departamento* y *id_empleado*.

Esto asegura que cada empleado tenga una identificación única dentro de cada departamento.


```sql
CREATE TABLE usuarios (
    id_departamento INT,
    id_empleado INT,
    nombre VARCHAR(100),
    PRIMARY KEY (id_departamento, id_empleado)
);

INSERT INTO usuarios (id_departamento, id_empleado, nombre) VALUES
(1, 101, 'Juan Pérez'),
(1, 102, 'María García'),
(2, 201, 'Pedro López'),
(2, 202, 'Lorena Díaz');

```


|id_departamento| id_empleado |   nombre	|
|---------------|-------------|-------------|
|             1 |         101 | Juan Pérez	|
|             1 |         102 | María García|
|             2 |         201 | Pedro López	|
|             2 |         202 | Lorena Díaz	|


## UUID

### Comando para generar UUID de PostgreSQL

```sql
SELECT gen_random_uuid();
```

Se debe crear una extensión para poder usar **uuid-ossp**, ya que no viene en PostgreSQL por defecto.

```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

Esta extensión nos crea todas las funciones de UUID. Se pueden ver en la carpeta **Funciones**.

<p align="center">
  <img src="/uuid.png" width="800" alt="uuid"/>
</p>

Para más información visite: https://www.postgresql.org/docs/current/uuid-ossp.html

```sql
SELECT uuid_generate_v4();
```
Este **SELECT** genera un UUID versión 4, que se deriva enteramente de números aleatorios.


Ahora crearemos un usuario usando el UUID:

```sql
CREATE TABLE users5 (
	"user_id" UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
	"username" VARCHAR
);
```

### Borrar todas las extensiones

```sql
DROP EXTENSION "uuid-ossp";
```